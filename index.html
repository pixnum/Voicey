<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voicey - Voice Recorder</title>
<style>
body{margin:0;padding:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#121212;color:#fff;font-family:'Segoe UI',sans-serif;}
.app-frame{border:2px solid rgba(255,255,255,0.3);border-radius:25px;padding:20px;background:rgba(255,255,255,0.05);backdrop-filter:blur(12px);width:95%;max-width:600px;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.5);transition:all 0.3s;}
h1{margin-bottom:20px;font-size:1.8rem;}
.controls button, select{background:linear-gradient(145deg,#1f1f1f,#2c2c2c);border:none;color:#fff;padding:10px 15px;margin:5px;border-radius:50px;cursor:pointer;font-size:1rem;transition:0.3s;}
.controls button:hover, select:hover{background:linear-gradient(145deg,#2c2c2c,#1f1f1f);transform:scale(1.05);}
audio{margin-top:20px;width:100%;outline:none;border-radius:10px;background:#1f1f1f;transition:all 0.3s;}
.toggle-dark{margin-top:20px;background:transparent;border:1px solid #fff;border-radius:25px;padding:10px 20px;cursor:pointer;transition:all 0.3s;}
.toggle-dark:hover{background:rgba(255,255,255,0.1);}
.canvas-container{position:relative;margin-top:20px;}
canvas{width:100%;height:150px;border-radius:10px;background: rgba(0,0,0,0.1);}
.vu-meter{position:absolute;top:0;right:10px;width:20px;height:100%;background: rgba(255,255,255,0.05);border-radius:10px;overflow:hidden;}
.vu-bar{width:100%;height:0%;background:lime;transition:height 0.05s;}
.db-display{position:absolute;top:0;right:40px;font-size:0.9rem;color:#0ff;}
.timer-display{display:block;margin-top:10px;font-size:1.2rem;font-weight:bold;color:#0ff;}
@media(max-width:600px){.controls button, select{padding:8px 12px;font-size:0.9rem;}}
body.light-mode{background:#f5f5f5;color:#000;}
body.light-mode .app-frame{background: rgba(0,0,0,0.05);border: 2px solid rgba(0,0,0,0.3);color:#000;}
body.light-mode .controls button, body.light-mode select{background:linear-gradient(145deg,#e0e0e0,#c0c0c0);color:#000;}
body.light-mode .controls button:hover, body.light-mode select:hover{background:linear-gradient(145deg,#c0c0c0,#e0e0e0);}
body.light-mode audio{background:#e0e0e0;}
body.light-mode .toggle-dark{border:1px solid #000;}
body.light-mode canvas{background: rgba(255,255,255,0.05);}
</style>
</head>
<body>
<div class="app-frame">
<h1>Voicey</h1>
<div class="controls">
<select id="wavRate">
  <option value="22050">WAV: 22050 Hz</option>
  <option value="44100" selected>WAV: 44100 Hz</option>
  <option value="48000">WAV: 48000 Hz</option>
</select>
<br>
<button id="recordBtn">Record</button>
<button id="pauseBtn" disabled>Pause</button>
<button id="stopBtn" disabled>Stop</button>
<button id="downloadWav" disabled>Download WAV</button>
<span class="timer-display" id="timerDisplay">00:00</span>
</div>
<div class="canvas-container">
<canvas id="waveform"></canvas>
<div class="vu-meter"><div class="vu-bar" id="vuBar"></div></div>
<div class="db-display" id="dbDisplay">0 dB</div>
</div>
<audio id="audioPlayback" controls></audio>
<button class="toggle-dark" id="darkModeToggle">Toggle Dark Mode</button>
<p style="margin-top:15px;font-size:0.8rem;">Â© Voicey 2025</p>
</div>

<script>
let mediaRecorder, audioChunks=[], recordedBuffer=[], timerInterval=0, seconds=0;
const audio=document.getElementById('audioPlayback');
const recordBtn=document.getElementById('recordBtn');
const pauseBtn=document.getElementById('pauseBtn');
const stopBtn=document.getElementById('stopBtn');
const downloadWav=document.getElementById('downloadWav');
const wavRateSelect=document.getElementById('wavRate');
const timerDisplay=document.getElementById('timerDisplay');
const canvas=document.getElementById('waveform');
const ctx=canvas.getContext('2d');
const vuBar=document.getElementById('vuBar');
const dbDisplay=document.getElementById('dbDisplay');

let audioCtx, analyser, source, dataArray, animationId;

function resizeCanvas(){canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight;}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function getColorForAmplitude(value){
  if(value<0.33) return '#00ff00';
  if(value<0.66) return '#ffff00';
  return '#ff0000';
}

function drawWaveformStereo(leftData,rightData){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const halfHeight=canvas.height/2;
  function drawChannel(data, yOffset){
    ctx.beginPath();
    let sliceWidth=canvas.width/data.length;
    let x=0;
    let peak=0;
    for(let i=0;i<data.length;i++){
      let v=(data[i]-128)/128;
      if(Math.abs(v)>peak) peak=Math.abs(v);
      let y=v*halfHeight + yOffset;
      ctx.lineTo(x,y);
      x+=sliceWidth;
    }
    ctx.strokeStyle='#0ff';
    ctx.lineWidth=2;
    ctx.stroke();
    return peak;
  }
  let peakLeft=drawChannel(leftData,halfHeight/2);
  let peakRight=drawChannel(rightData,halfHeight + halfHeight/2);
  let rms=(peakLeft+peakRight)/2;
  let db=Math.max(-60,20*Math.log10(rms));
  dbDisplay.textContent=db.toFixed(1)+' dB';
  vuBar.style.height=Math.min(100,rms*200)+'%';
}

function drawLoop(){
  animationId=requestAnimationFrame(drawLoop);
  if(!analyser) return;
  analyser.getByteTimeDomainData(dataArray);
  // Split stereo channels (approximation)
  let left=[], right=[];
  for(let i=0;i<dataArray.length;i++){
    if(i%2===0) left.push(dataArray[i]); else right.push(dataArray[i]);
  }
  drawWaveformStereo(left,right);
}

// Timer
function startTimer(){seconds=0; timerDisplay.textContent='00:00'; timerInterval=setInterval(()=>{
  seconds++;
  let m=Math.floor(seconds/60).toString().padStart(2,'0');
  let s=(seconds%60).toString().padStart(2,'0');
  timerDisplay.textContent=`${m}:${s}`;
},1000);}
function stopTimer(){clearInterval(timerInterval); timerDisplay.textContent='00:00';}

// Recording
recordBtn.addEventListener('click', async ()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:44100,channelCount:2,noiseSuppression:true,echoCancellation:true,autoGainControl:true}});
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    source=audioCtx.createMediaStreamSource(stream);
    const filter=audioCtx.createBiquadFilter();
    filter.type='lowpass'; filter.frequency.value=15000;
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;
    dataArray=new Uint8Array(analyser.fftSize);
    source.connect(filter); filter.connect(analyser);
    drawLoop();
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[]; recordedBuffer=[];
    mediaRecorder.ondataavailable=e=>{
      audioChunks.push(e.data);
      const reader=new FileReader();
      reader.onloadend=()=>recordedBuffer.push(reader.result);
      reader.readAsArrayBuffer(e.data);
    };
    mediaRecorder.onstop=async()=>{
      const blob=new Blob(audioChunks,{type:'audio/webm'});
      audio.src=URL.createObjectURL(blob);
      downloadWav.disabled=false;
      cancelAnimationFrame(animationId);
      stopTimer();
    };
    mediaRecorder.start();
    recordBtn.disabled=true; pauseBtn.disabled=false; stopBtn.disabled=false; downloadWav.disabled=true;
    startTimer();
  }catch(err){alert('Microphone access denied'); console.error(err);}
});

pauseBtn.addEventListener('click', ()=>{
  if(mediaRecorder.state==='recording'){ mediaRecorder.pause(); pauseBtn.textContent='Resume'; stopTimer(); }
  else if(mediaRecorder.state==='paused'){ mediaRecorder.resume(); pauseBtn.textContent='Pause'; startTimer(); }
});

stopBtn.addEventListener('click', ()=>{
  if(mediaRecorder&&(mediaRecorder.state==='recording'||mediaRecorder.state==='paused')) mediaRecorder.stop();
  recordBtn.disabled=false; pauseBtn.disabled=true; stopBtn.disabled=true; pauseBtn.textContent='Pause';
  stopTimer();
});

downloadWav.addEventListener('click', async ()=>{
  if(recordedBuffer.length){
    const wavRate=parseInt(wavRateSelect.value);
    const mergedBuffer=new Uint8Array(recordedBuffer.reduce((acc,b)=>acc+new Uint8Array(b).length,0));
    let offset=0;
    for(let b of recordedBuffer){
      let arr=new Uint8Array(b);
      mergedBuffer.set(arr,offset);
      offset+=arr.length;
    }
    const audioCtx2=new (window.AudioContext||window.webkitAudioContext)();
    const audioData=await audioCtx2.decodeAudioData(mergedBuffer.buffer);
    const left=audioData.getChannelData(0);
    const right=audioData.numberOfChannels>1?audioData.getChannelData(1):left;
    // Interleave stereo
    const interleaved=new Float32Array(left.length*2);
    for(let i=0;i<left.length;i++){ interleaved[i*2]=left[i]; interleaved[i*2+1]=right[i]; }
    function encodeWAV(samples, sampleRate){
      const buffer=new ArrayBuffer(44+samples.length*2);
      const view=new DataView(buffer);
      function writeString(v,o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}
      let offset=0; writeString(view,offset,'RIFF'); offset+=4;
      view.setUint32(offset,36+samples.length*2,true); offset+=4; writeString(view,offset,'WAVE'); offset+=4;
      writeString(view,offset,'fmt '); offset+=4; view.setUint32(offset,16,true); offset+=4;
      view.setUint16(offset,1,true); offset+=2; view.setUint16(offset,2,true); offset+=2;
      view.setUint32(offset,sampleRate,true); offset+=4; view.setUint32(offset,sampleRate*4,true); offset+=4;
      view.setUint16(offset,4,true); offset+=2; view.setUint16(offset,16,true); offset+=2;
      writeString(view,offset,'data'); offset+=4; view.setUint32(offset,samples.length*2,true); offset+=4;
      let pos=44; for(let i=0;i<samples.length;i++){ let s=Math.max(-1,Math.min(1,samples[i])); view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true); pos+=2; }
      return new Blob([view],{type:'audio/wav'});
    }
    const wavBlob=encodeWAV(interleaved,wavRate);
    const a=document.createElement('a'); a.href=URL.createObjectURL(wavBlob); a.download='VoiceyRecording.wav'; a.click();
  }
});

document.getElementById('darkModeToggle').addEventListener('click', ()=>document.body.classList.toggle('light-mode'));
</script>
</body>
</html>
